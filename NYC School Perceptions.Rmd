---
title: NYC School Perceptions
output: 
  html_notebook: 
    fig_caption: yes
by: Mari Osmundson
editor_options: 
  chunk_output_type: console
---

This project uses data from two sources: 1) the City of New York's data website, found at https://data.cityofnewyork.us/Education/2011-NYC-School-Survey/mnz3-dyi8. The two files were imported from text. They contain information about the 2011 parent/teacher/student survey results from the NYC school district. 2) A cleaned dataset named "combined" was imported using read.csv, courtesy of Dataquest: https://data.world/dataquest/nyc-schools-data/workspace/file?filename=combined.csv. I also added average household income data for each NYC borough from a third source: https://www.census.gov/quickfacts/fact/table/newyorkcitynewyork,bronxcountybronxboroughnewyork,kingscountybrooklynboroughnewyork,newyorkcountymanhattanboroughnewyork,queenscountyqueensboroughnewyork,richmondcountystatenislandboroughnewyork/PST045218. 


I have loaded the tidyverse package in R Notebook.

I filtered masterfile11_gened_final and masterfile11_d75_final by column V6, "highschool", to retain only high schools. I selected relevant columns and saved the results to two dataframes: gened_filter and d75_filter.

```{r}
gened_filter <- masterfile11_gened_final %>%
  filter(`V6` != "0") %>%
  select(`V1`, `V2`, `V3`, `V4`, `V7`, `V17`:`V32`)

d75_filter <- masterfile11_d75_final %>%
  filter(`V6` != "0") %>%
  select(`V1`:`V3`, `V17`:`V32`)
```

Removed two more columns from gened_filter in order to merge it with d75_filter using rbind().
```{r}
gened_filter <- gened_filter %>%
  select(-`V4`, -`V7`)
```

Merged the two filtered dataframes into one.
```{r}
gened_d75 <- rbind(gened_filter, d75_filter)
```

Changed column name to `DBN` to use it as the key for the left join.
```{r}
gened_d75 <- (`DBN` = `V1`)
```

I joined the dataframes using DBN as the key, then belatedly realized the column names didn't transfer when I imported the original text files into R Studio. I utilized colnames() to transfer all column names to combined_join, then ran the code again to form the join.
```{r}
combined_join <- combined %>%
  left_join(gened_d75, key = `DBN`)

colnames(gened_d75) <- c("DBN", "bn", "schoolname", "saf_p_11", "com_p_11", "eng_p_11", "aca_p_11", "saf_t_11", "com_t_11", "eng_t_11", "aca_t_11", "saf_s_11", "com_s_11", "eng_s_11", "aca_s_11", "saf_tot_11", "com_tot_11", "eng_tot_11", "aca_tot_11")

combined_join <- combined %>%
  left_join(gened_d75, key = `DBN`)
```

The survey results needed to become numeric types in order to run correlations.
```{r}
combined_join <- combined_join %>%
    mutate_at(33:48, as.numeric)
```

I created a correlation tibble to examine any relationship between average SAT scores and the survey variables.
```{r}
combined_matrix <- combined_join %>%
  select(avg_sat_score, saf_p_11:aca_tot_11) %>%
  cor(use = "pairwise.complete.obs")

combined_tibble <- combined_matrix %>%
  as.tibble(rownames = "variable")

```

I also wanted to run plots for NYC's boroughs and any potential correlation between them and the variables in combined_join. I have dropped NAs from the borough column (boro) and removed NAs from calculations of each variable's mean.
```{r}
boro_group <- combined_join %>%
    drop_na(boro) %>%
    group_by(boro) %>%
    summarize(average_SAT_score = mean(avg_sat_score, na.rm = TRUE),
              average_class_size = mean(avg_class_size, na.rm = TRUE),
              average_frl_percent = mean(frl_percent, na.rm = TRUE),
              average_ell_percent = mean(ell_percent, na.rm = TRUE),
              average_sped_percent = mean(sped_percent, na.rm = TRUE),
              average_asian_percent = mean(asian_per, na.rm = TRUE),
              average_black_percent = mean(black_per, na.rm = TRUE),
              average_hispanic_percent = mean(hispanic_per, na.rm = TRUE),
              average_white_percent = mean(white_per, na.rm = TRUE),
              average_grads_percent = mean(grads_percent, na.rm = TRUE),
              average_dropout_percent = mean(dropout_percent, na.rm = TRUE),
              average_safety_score = mean(saf_tot_11, na.rm = TRUE),
              average_comm_score = mean(com_tot_11, na.rm = TRUE),
              average_engagement_score = mean(eng_tot_11, na.rm = TRUE),
              average_expectations_score = mean(aca_tot_11, na.rm = TRUE))

```

I decided to add each borough's average household income to the dataframe since I was curious if there was a correlation. The data came from 
```{r}
boro_avg_income_2017_dollars <- c(36593, 52782, 79781, 62008, 76244)
boro_group$boro_avg_income <- boro_avg_income_2017_dollars

```

```{r}
create_scatter <- function(x,y) {
ggplot(data = boro_group) +
    aes_string(x = x, y = y) +
    geom_point(alpha = 0.3)
}

x_var <- names(boro_group)[1]
y_var <- names(boro_group)[2:17]

boro_variable_comp <- map2(x_var, y_var, create_scatter)
```


```{r}
print(boro_variable_comp)
```

There is a weak positive correlation between average SAT score and teachers' safety scores, students' safety scores, total safety score, and academic expectations of students.
```{r}
combined_select <- combined_tibble %>%
  select(variable, avg_sat_score) %>%
  filter(avg_sat_score > 0.25 | avg_sat_score < -0.25)
```

I used gather() to organize the data by survey response type (parent, teacher, student, total) for each school.
```{r}
comb_resp_gather <- combined_join %>%
  gather(key = "responder", value = score, saf_p_11:aca_tot_11)
```

Subset the responder column into response type (i.e. parent) and question (i.e. saf).
```{r}
comb_resp_gather <- comb_resp_gather %>%
  mutate(response_type = str_sub(responder, 4, 6 ),
         question = str_sub(responder, 1, 3))
```

Changed the abbreviated letters in response_type to full words for clarity.
```{r}
comb_resp_gather <- comb_resp_gather %>%
  mutate(response_type = ifelse(response_type == "_p_", "parent",
                                ifelse(response_type == "_t_", "teacher",
                                       ifelse(response_type == "_s_", "student",
                                              ifelse(response_type == "_to", "total", "NA")))))
```

Changed the question column's abbreviations into words for clarity.
```{r}
comb_resp_gather <- comb_resp_gather %>%
  mutate(question = ifelse(question == "saf", "safety+respect",
                                ifelse(question == "com", "communication",
                                       ifelse(question == "eng", "engagement",
                                              ifelse(question == "aca", "acad. expectations", "NA")))))
```

I'm going to experiment with some plots, see which one(s) provide the most data. I grouped the dataframe by response_type and ran a bar chart plot to see the spread of averages. Teachers had the highest average score and students the lowest.
```{r}
response_group <- comb_resp_gather %>%
  group_by(response_type) %>%
  summarize(avg_score = mean(score, na.rm = "TRUE"))

response_group_plots <- ggplot(data = response_group) +
  aes(x = response_type, y = avg_score) +
  geom_bar(stat = "identity")
print(response_group_plots)
```

I grouped by the question column and ran another bar chart plot on the averages. There was not great variation in the average scores among the question types. Safety and respect scored the highest, academic expectations scored the lowest.
```{r}
question_group <- comb_resp_gather %>%
  group_by(question) %>%
  summarize(avg_score = mean(score, na.rm = "TRUE"))

question_group_plots <- ggplot(data = question_group) +
  aes(x = question, y = avg_score) +
  geom_bar(stat = "identity")
print(question_group_plots)
```

Teachers have significantly higher scores. Students have the lowest scores.
```{r}
response_box <- ggplot(data = comb_resp_gather) +
    aes(x = response_type, y = score) +
    geom_boxplot()
print(response_box)
```

The distribution of scores among questions is fairly similar, with safety and respect having the highest median score and highest IQR.
```{r}
question_box <- ggplot(data = comb_resp_gather) +
    aes(x = question, y = score) +
    geom_boxplot()
print(question_box)
```

In the following plot, teachers had both significantly higher scores in all four question types, as well as a greater distribution of scores within each question type. Students provided the lowest scores for each question.
```{r}
question_response_combo <- ggplot(data = comb_resp_gather) +
    aes(x = question, y = score, fill = response_type) +
    geom_boxplot()
print(question_response_combo)
```

Interesting to notice that in the following plot's distribution, parents and students scored safety and respect higher than the other questions. Teachers again showed a greater distribution of scores and higher scores than parents and students.
```{r}
question_response_combo2 <- ggplot(data = comb_resp_gather) +
    aes(x = response_type, y = score, fill = question) +
    geom_boxplot()
print(question_response_combo2)
```


Next steps: Wrap this baby up and put it to bed! Don't forget to delete these comments... Post the project. Future project: examine data by borough and income.
Add a new chunk by clicking the *Insert Chunk* button on the toolbar or by pressing *Cmd+Option+I*.

When you save the notebook, an HTML file containing the code and output will be saved alongside it (click the *Preview* button or press *Cmd+Shift+K* to preview the HTML file). 

The preview shows you a rendered HTML copy of the contents of the editor. Consequently, unlike *Knit*, *Preview* does not run any R code chunks. Instead, the output of the chunk when it was last run in the editor is displayed.

